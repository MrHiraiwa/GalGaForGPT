!DOCTYPE html
html
  head
    
    titleギャルゲーGPTtitle
    meta name=viewport content=width=device-width, initial-scale=1.0
    style

body {
  margin 0;
  padding 0;
  font-size clamp(15px, 1vw, 25px);
  background-image url('httpsassets.st-note.comimg1683894319155-7lAfiEZRHw.png');
  background-size cover;
  background-position center;
  background-repeat no-repeat;
  transition background-image 2s ease-in-out, opacity 2s ease-in-out;
  opacity 0;
  transition background-image 2s ease-in-out;
}

body.visible {
  opacity 1;
}

body.fadeout {
  opacity 0;
  transition opacity 2s ease-in-out;
}

#container {
  max-width 90%;
  width 100%;
  margin 0 auto;
  padding 10px;
  display flex;
  flex-direction column;
  justify-content flex-end;
  height 100vh;
}


#responseContainer {
  min-height calc(6  1.2em  1.5);
  max-height calc(6  1.2em  1.5);
  width 100%;
  overflow-y scroll;
  border 1px solid #ccc;
  padding 5px;
  margin-bottom 0.5em;
  box-sizing border-box;
  background-color rgba(255, 255, 255, 0.7);
}

input[type=text] {
  background-color rgba(255, 255, 255, 0.7);
  border 1px solid #ccc;
  padding 5px;
  outline none;
  width 80%;
  transition background-color 0.3s;
}

input[type=text]focus {
  background-color rgba(255, 255, 255, 1);
}

button {
  background-color #4CAF50;
  border none;
  color white;
  padding 5px 10px;
  text-align center;
  text-decoration none;
  display inline-block;
  font-size 16px;
  margin 4px 2px;
  cursor pointer;
}
      
.input-container {
  margin-bottom 2em;
  position relative;
}

#muteButton {
  position fixed;
  right 10px;
  top 10px;
  background-color #FFD700;
  color white;
  border none;
  padding 5px;
  outline none;
  font-size 16px;
  cursor pointer;
  transition background-color 0.3s;
}

#muteButtonfocus {
  background-color #FFC400;
}
   
    style
    script

const helloMassage = オフィスに入るとそこには眼鏡をかけた長い黒髪の女性が座っていた。
let isUserNameEntered = false;
let forgetWord = false;
const scrollAnimationDuration = 2000;
let isFirstInteraction = true;

function playAudio(byteArrayAudio) {
  const audioBlob = byteArrayToBlob(byteArrayAudio);
  const audioUrl = URL.createObjectURL(audioBlob);
  const audio = new Audio(audioUrl);
  audio.play().catch(err = console.error('音声再生エラー', err));
}

function byteArrayToBlob(byteArray) {
  const len = byteArray.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i  len; i++) {
    bytes[i] = byteArray[i];
  }
  return new Blob([bytes], { type 'audiowav' });
}

function generateUserId() {
  if (!localStorage.getItem('userId')) {
    const userId = Math.random().toString(36).substr(2, 9);
    localStorage.setItem('userId', userId);
  }
  return localStorage.getItem('userId');
}

function submitForm(userId) {
if (isFirstInteraction) {
  const audioElement = document.querySelector(audio);
  audioElement.muted = false;
  audioElement.play().catch(err = console.error('音楽再生エラー', err));
  hasPlayed = true;
  isFirstInteraction = false;
}

  const userMessageInput = document.getElementById(userMessage);
  const sendButton = document.querySelector(button);
  userMessageInput.disabled = true;
  sendButton.disabled = true;
  const userName = document.getElementById(userName).value  You;
  const userMessage = userMessageInput.value;
  showUserMessage(userMessage, userName);
  google.script.run.withSuccessHandler(function(reply) {
    playAudio(reply.audio);
    showReply(reply.text);
    userMessageInput.disabled = false;
    sendButton.disabled = false;
    userMessageInput.placeholder = 何かお話しして;
    userMessageInput.focus();
  }).sendMessage(userName +   + userMessage, userName, userId);
  checkForResetCommand();
  document.getElementById(userMessage).value = ;
  checkUserName();
  userMessageInput.focus();
}




async function showUserMessage(userMessage, userName) {
  const responseContainer = document.getElementById(responseContainer);
  const userMessageInput = document.getElementById(userMessage);
  userMessageInput.placeholder = お待ちください;
  userMessageInput.disabled = true;

  if (forgetWord === true) {
    responseContainer.innerHTML = ;
    forgetWord = false;
  }
  await typeMessage(responseContainer, userName +   + userMessage + br);
  responseContainer.scrollTop = responseContainer.scrollHeight;
  document.getElementById(userMessage).disabled = true;
  document.querySelector(button).disabled = true;

  await new Promise(resolve = setTimeout(resolve, scrollAnimationDuration));
}

function extractEmotions(emotionText) {
  const emotionStrings = emotionText.match(【感情】(.)【会話】s);
  
  if (!emotionStrings) {
    return null;
  }

  const emotions = {
    joy 0,
    anger 0,
    sadness 0,
    fun 0,
    confidence 0,
    confusion 0,
    fear 0,
    love 0,
  };

  const emotionData = emotionStrings[1].split(',');

  for (const emotionString of emotionData) {
    const [emotionName, value] = emotionString.trim().split('');

    switch (emotionName) {
      case '喜び'
        emotions.joy = parseInt(value, 10);
        break;
      case '怒り'
        emotions.anger = parseInt(value, 10);
        break;
      case '悲しみ'
        emotions.sadness = parseInt(value, 10);
        break;
      case '楽しさ'
        emotions.fun = parseInt(value, 10);
        break;
      case '自信'
        emotions.confidence = parseInt(value, 10);
        break;
      case '困惑'
        emotions.confusion = parseInt(value, 10);
        break;
      case '恐怖'
        emotions.fear = parseInt(value, 10);
        break;
      case '愛情'
        emotions.love = parseInt(value, 10);
        break;        
    }
  }

  return emotions;
}

function endingCheck(emotions) {
  if (emotions.love === 5 && emotions.fun = 3 && emotions.joy = 3) {
    const responseContainer = document.getElementById(responseContainer);
    changeBackgroundImage(httpsassets.st-note.comimg1683894261641-wyCkqrMYLA.png);
    const message = さくらの愛情は最高に達しました。ゲームクリアです。;
    typeMessage(responseContainer, message + br);
    const waitTime = 5000;
    setTimeout(() = {
      document.body.classList.add(fadeout);
    }, waitTime);
  }
}

function changeBackgroundImageBasedOnEmotions(emotions) {
  if (emotions.joy = 3) {
    changeBackgroundImage(httpsassets.st-note.comimg1683894303523-dGD8ffkQnu.png);
  } else if (emotions.anger = 3) {
    changeBackgroundImage(httpsassets.st-note.comimg1683894251619-L0FvPq0qUj.png);
  } else if (emotions.sadness = 3) {
    changeBackgroundImage(httpsassets.st-note.comimg1683894327157-TWRw9OgoGp.png);
  } else if (emotions.fun = 3) {
    changeBackgroundImage(httpsassets.st-note.comimg1683894295401-tyvMPOftMO.png);
  } else if (emotions.confidence = 3) {
    changeBackgroundImage(httpsassets.st-note.comimg1683894268482-vclu6dTa1W.png);
  } else if (emotions.confusion = 3) {
    changeBackgroundImage(httpsassets.st-note.comimg1683894277559-WAPCtIxKvh.png);
  } else if (emotions.fear = 3) {
    changeBackgroundImage(httpsassets.st-note.comimg1683894287934-ebb82R8TvY.png);
  } else if (emotions.love = 3) {
    changeBackgroundImage(httpsassets.st-note.comimg1683894311634-HFfwcxYG8J.png);
  } else {
    changeBackgroundImage(httpsassets.st-note.comimg1683894319155-7lAfiEZRHw.png);
  }
}

async function showReply(reply) {
  const emotions = extractEmotions(reply);
  console.log(抽出された感情, emotions);
  if (emotions) {
    changeBackgroundImageBasedOnEmotions(emotions);
  }
  const emotionPattern = 【感情】.【会話】sg;
  const cleanedReply = reply.replace(emotionPattern, '');
  const responseContainer = document.getElementById(responseContainer);
  const userMessageInput = document.getElementById(userMessage);
  await typeMessage(responseContainer, cleanedReply + br);
  responseContainer.scrollTop = responseContainer.scrollHeight;
  if (emotions) {
    endingCheck(emotions);    
  }
  userMessageInput.disabled = false;
  document.querySelector(button).disabled = false;
  userMessageInput.placeholder = 何かお話しして;
  userMessageInput.focus();
}


function hideUserNameInput() {
  const userNameInput = document.getElementById(userName);
  userNameInput.style.display = none;
}

function checkUserName() {
  const userNameInput = document.getElementById(userName);
  const userName = userNameInput.value;
  if (userName) {
    userNameInput.style.display = none;
  } else {
    userNameInput.style.display = block;
  }
}

function setUserName(userName) {
  const userNameInput = document.getElementById(userName);
  userNameInput.value = userName;
  checkUserName();
}
      
function checkForResetCommand() {
  const userMessage = document.getElementById(userMessage).value;
  if (userMessage === 忘れて  userMessage === わすれて) {
    resetUserName();
    forgetWord = true;
  }
}

function resetUserName() {
  const userNameInput = document.getElementById(userName);
  userNameInput.value = ;
  userNameInput.style.display = block;
}

function loadPreviousMessages(userId) {
  google.script.run.withSuccessHandler(displayPreviousMessages).getPreviousMessages(userId);
}

async function displayPreviousMessages(messages) {
  const responseContainer = document.getElementById(responseContainer);
  if (messages.length === 0) {
    document.getElementById(userMessage).disabled = true;
    document.querySelector(button).disabled = true;
    const userMessageInput = document.getElementById(userMessage);
    userMessageInput.placeholder = お待ちください; 
    await typeMessage(responseContainer, helloMassage + br);
    userMessageInput.placeholder = 何かお話しして;
    document.getElementById(userMessage).disabled = false;
    document.querySelector(button).disabled = false;
  } else {
    for (let message of messages) {
      const extractedName = extractNameFromLog(message.content);
      if (extractedName) {
        setUserName(extractedName);
      }
      const cleanedMessage = message.content.replace(user.undefinedsassistants, '').replace(.として返信して。( undefined)s, '').replace(undefineds, '').replace(【感情】.【会話】sg).replace(undefined, '');
      responseContainer.innerHTML += cleanedMessage + br;
    }
  }
  responseContainer.scrollTop = responseContainer.scrollHeight;
}


function extractNameFromLog(log) {
  const pattern = undefineds(.+)s.+;
  const match = log.match(pattern);

  if (match) {
    return match[1];
  } else {
    return null;
  }
}

async function typeMessage(element, message) {
  let temp = ;
  let isTag = false;
  const initialHeight = element.scrollHeight;
  const originalContent = element.innerHTML;

  for (let i = 0; i  message.length; i++) {
    if (message[i] ===  && message[i + 1] === b && message[i + 2] === r && message[i + 3] === ) {
      temp += br;
      i += 3;
      isTag = true;
    } else {
      temp += message[i];
    }
    element.innerHTML = originalContent + temp;
    await new Promise(resolve = setTimeout(resolve, 50));
    if (element.scrollHeight  element.clientHeight) {
      const scrollAmount = element.scrollHeight - element.clientHeight;
      smoothScroll(element, element.scrollTop + scrollAmount, scrollAnimationDuration);
    } else {
      element.scrollTop = element.scrollHeight;
    }
  }
}

function getTextHeight(element, text) {
  const testDiv = document.createElement(div);
  testDiv.style.position = absolute;
  testDiv.style.visibility = hidden;
  testDiv.style.width = element.clientWidth + px;
  testDiv.style.whiteSpace = pre-wrap;
  testDiv.style.wordWrap = break-word;
  testDiv.style.padding = window.getComputedStyle(element).padding;
  testDiv.innerHTML = text;
  document.body.appendChild(testDiv);
  const height = testDiv.clientHeight;
  document.body.removeChild(testDiv);
  return height;
}

function smoothScroll(element, target, duration) {
  const start = element.scrollTop;
  const change = target - start;
  const startTime = performance.now();
  function animateScroll(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed  duration, 1);
    element.scrollTop = start + change  progress;
    if (progress  1) {
      requestAnimationFrame(animateScroll);
    }
  }

  requestAnimationFrame(animateScroll);
}

let hasPlayed = false;

function playMusicOnTouch() {
  if (!hasPlayed) {
    const audioElement = document.querySelector(audio);
    audioElement.play();
    hasPlayed = true;
  }
}

document.addEventListener(DOMContentLoaded, function () {
  document.body.addEventListener(touchstart, playMusicOnTouch);
});


const imagesToPreload = [
httpsassets.st-note.comimg1683894303523-dGD8ffkQnu.png,
httpsassets.st-note.comimg1683894251619-L0FvPq0qUj.png,
httpsassets.st-note.comimg1683894327157-TWRw9OgoGp.png,
httpsassets.st-note.comimg1683894295401-tyvMPOftMO.png,
httpsassets.st-note.comimg1683894268482-vclu6dTa1W.png,
httpsassets.st-note.comimg1683894277559-WAPCtIxKvh.png,
httpsassets.st-note.comimg1683894287934-ebb82R8TvY.png,
httpsassets.st-note.comimg1683894311634-HFfwcxYG8J.png,
httpsassets.st-note.comimg1683894319155-7lAfiEZRHw.png,
httpsassets.st-note.comimg1683894261641-wyCkqrMYLA.png,
];

function preloadImages() {
  for (const imageUrl of imagesToPreload) {
    const img = new Image();
    img.src = imageUrl;
  }
}

const audioToPreload = [
  httpsdrive.google.comucid=1yNNL49oOsAUo9f_u5OVjatr7w1AEnRBI,
];

function preloadAudio() {
  for (const audioUrl of audioToPreload) {
    const audio = new Audio();
    audio.src = audioUrl;
  }
}

window.addEventListener(load, preloadAudio);
window.addEventListener(load, preloadImages);

function changeBackgroundImage(newImageUrl) {
  document.body.style.backgroundImage = `url('${newImageUrl}')`;
}

function toggleMute() {
  const audioElement = document.querySelector(audio);
  const muteButton = document.getElementById(muteButton);

  if (audioElement.muted) {
    audioElement.muted = false;
    muteButton.textContent = ミュート;
  } else {
    audioElement.muted = true;
    muteButton.textContent = オン;
  }
}

function fadeIn(element) {
  element.classList.add(visible);
}

window.addEventListener(load, () = {
  const body = document.querySelector(body);
  setTimeout(() = fadeIn(body), 2000);
});


    script
  head
body
    audio loop muted
    source src=httpsdrive.google.comucid=1yNNL49oOsAUo9f_u5OVjatr7w1AEnRBI type=audiompeg
    audio
    script
      let userId;

      window.onload = function () {
        userId = generateUserId();
        loadPreviousMessages(userId);
      };
    script

    div id=container
      div id=responseContainerdiv
      div class=input-container
        div class=input-elements
          input type=text id=userName placeholder=あなたの名前を教えて
          input type=text id=userMessage placeholder=何かお話しして onkeydown=if (event.keyCode == 13) submitForm(userId)
          button onclick=submitForm(userId)送信button
        div
      div
    div
    button id=muteButton onclick=toggleMute()ミュートbutton
  body
html

